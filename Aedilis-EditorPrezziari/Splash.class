' Gambas class file

PUBLIC DBConnect AS Connection
PUBLIC DBResult AS Result
PUBLIC Browser AS String

PUBLIC SUB CheckConnection()
DIM ConfFile AS File
DIM linea AS String

DBConnect = NEW Connection

TRY ConfFile = OPEN user.Home & "/.Aedilis/DBConfig" FOR READ 
  IF ERROR THEN 
     Message.Info("Non esiste il file di configurazione del DB, lancio il software di configurazione")
     SHELL "aedilisdbconf.gambas" WAIT 
     ME.Close
  ELSE 
     LINE INPUT #ConfFile, DBConnect.Host
     LINE INPUT #ConfFile, DBConnect.Login
     LINE INPUT #ConfFile, DBConnect.Password
     LINE INPUT #ConfFile, DBConnect.Name
     LINE INPUT #ConfFile, DBConnect.Type
     
     TRY DBConnect.Begin
     IF ( ERROR ) THEN 
          Message.Info("Errore nella connessione a Mysql: " & Error.Text & ", lancio il software di configurazione")
          SHELL "aedilisdbconf.gambas"
          Splash.Close
     ELSE 
          CheckTables
     END IF
  END IF
  
END

PUBLIC SUB CheckTables()
DIM DBTable AS Table
DIM esiste AS Boolean
     esiste = DBConnect.Tables.Exist("ElPrezziari")
     IF (esiste = FALSE) THEN 
          DBTable = DBConnect.Tables.Add("ElPrezziari")
          DBTable.Fields.Add("Id", gb.Integer)
          DBTable.Fields.Add("Nome", gb.String)
          DBTable.Fields.Add("Versione", gb.Integer)
          DBTable.Update
          DBTable.PrimaryKey.Add("Id")
          DBResult = DBConnect.Exec("ALTER TABLE ElPrezziari ADD PRIMARY KEY(id)")
     ELSE 
          DBResult = DBConnect.Find("ElPrezziari")
          'PRINT DBResult.Fields.Count
          IF (DBResult.Fields.Count = 2) THEN 
               DBConnect.Exec("ALTER TABLE `ElPrezziari` ADD `versione` INT NOT NULL")
               DBResult = DBConnect.Exec("update ElPrezziari set versione=&1", 1)           
          END IF
     END IF
  
  
END

PUBLIC SUB LoadConfig()
DIM ConfFile AS File
DIM linea AS String

TRY ConfFile = OPEN user.Home & "/.Aedilis/Config" FOR READ 
  IF ERROR THEN 
     Message.Info("Non esiste il file di configurazione, lancio il software di configurazione")
     SHELL "aedilisconfigurator.gambas"
     ME.Close
  ELSE 
     LINE INPUT #ConfFile, linea
     Browser = linea
     Splash.Hide
     FMain.Show
     FMain.SetFocus
  END IF
  
  
END


PUBLIC SUB Form_Open()

     ME.Center  

END

PUBLIC SUB Timer1_Timer()
     Timer1.Enabled = FALSE



     CheckConnection()
     LoadConfig()


END

PUBLIC SUB PictureBox1_MouseDown()

  

END
